name: Auto Label PRs and Issues

on:
  pull_request:
    types: [opened, edited, synchronize, reopened, closed]
  issues:
    types: [opened, edited]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  auto-label:
    runs-on: ubuntu-latest
    name: Auto Label
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Handle closed PRs
        if: github.event_name == 'pull_request' && github.event.action == 'closed'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = context.issue.number;
            
            // Get all current labels
            const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number
            });
            
            // Remove all existing labels
            for (const label of currentLabels) {
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue_number,
                  name: label.name
                });
                console.log(`Removed label: ${label.name}`);
              } catch (error) {
                console.log(`Could not remove label ${label.name}: ${error.message}`);
              }
            }
            
            // Ensure the "Done" label exists with purple color
            try {
              await github.rest.issues.getLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'Done'
              });
            } catch (error) {
              if (error.status === 404) {
                // Create the label if it doesn't exist
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: 'Done',
                  color: '8B5CF6',
                  description: 'This PR has been closed'
                });
                console.log('Created "Done" label with purple color');
              }
            }
            
            // Add the "Done" label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              labels: ['Done']
            });
            
            console.log('PR closed: Removed all labels and added "Done" label');

      - name: Label based on file changes (PRs only)
        if: github.event_name == 'pull_request' && github.event.action != 'closed'
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/pr-labeler.yaml
          sync-labels: true

      - name: Sync size labels (PRs only)
        if: github.event_name == 'pull_request' && github.event.action != 'closed'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const issue_number = pr.number;
            const changes = pr.additions + pr.deletions;
            
            // Define size thresholds
            const sizes = [
              { label: 'size/xs', max: 10 },
              { label: 'size/s', max: 100 },
              { label: 'size/m', max: 500 },
              { label: 'size/l', max: 1000 },
              { label: 'size/xl', max: Infinity }
            ];
            
            // Determine correct size label
            let correctLabel = '';
            for (const size of sizes) {
              if (changes <= size.max) {
                correctLabel = size.label;
                break;
              }
            }
            
            // Get current labels
            const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number
            });
            
            // Remove all size labels
            const sizeLabels = sizes.map(s => s.label);
            for (const label of currentLabels) {
              if (sizeLabels.includes(label.name)) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue_number,
                  name: label.name
                });
              }
            }
            
            // Add correct size label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              labels: [correctLabel]
            });
            
            console.log(`PR has ${changes} changes. Applied label: ${correctLabel}`);

      - name: Sync content-based labels
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = context.issue.number;
            const isPR = !!context.payload.pull_request;
            const title = (isPR ? context.payload.pull_request.title : context.payload.issue.title) || '';
            const body = (isPR ? context.payload.pull_request.body : context.payload.issue.body) || '';
            const text = (title + ' ' + body).toLowerCase();
            
            // Define label rules
            const labelRules = {
              'bug': /\b(bug|error|issue|problem|crash|broken|fail|fix|not working|doesn't work|does not work)\b/,
              'enhancement': /\b(feature|enhancement|improvement|request|add|implement|support|enable|would be nice|could we|can we)\b/,
              'documentation': /\b(docs|documentation|readme|guide|tutorial|explain|clarify|document)\b/,
              'question': /\b(question|how to|help|wondering|what is|why does|when should)\b/,
              'performance': /\b(performance|slow|speed|optimize|optimization|faster|latency|bottleneck)\b/,
              'security': /\b(security|vulnerability|exploit|xss|csrf|injection|auth|authentication|authorization|permission)\b/,
              'ui/ux': /\b(ui|ux|design|layout|style|styling|interface|user experience|look and feel)\b/,
              'refactor': /\b(refactor|refactoring|cleanup|clean up|reorganize|code quality|technical debt)\b/,
              'breaking-change': /\b(breaking change|breaking|backwards incompatible|major version|migration required)\b/,
              'help-wanted': /\b(help wanted|help needed|looking for help|contributions welcome|need help)\b/
            };
            
            // Get current labels
            const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number
            });
            
            const currentLabelNames = currentLabels.map(l => l.name);
            const managedLabels = Object.keys(labelRules);
            
            // Determine which labels should be applied
            const labelsToApply = [];
            for (const [label, pattern] of Object.entries(labelRules)) {
              if (pattern.test(text)) {
                labelsToApply.push(label);
              }
            }
            
            // Remove labels that no longer apply
            for (const label of currentLabelNames) {
              if (managedLabels.includes(label) && !labelsToApply.includes(label)) {
                try {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue_number,
                    name: label
                  });
                  console.log(`Removed label: ${label}`);
                } catch (error) {
                  console.log(`Could not remove label ${label}: ${error.message}`);
                }
              }
            }
            
            // Add new labels
            const labelsToAdd = labelsToApply.filter(l => !currentLabelNames.includes(l));
            if (labelsToAdd.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue_number,
                labels: labelsToAdd
              });
              console.log(`Added labels: ${labelsToAdd.join(', ')}`);
            }

      - name: Welcome message for new PRs
        if: github.event_name == 'pull_request' && github.event.action == 'opened'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const author = context.payload.pull_request.user.login;
            
            // Check if this is a first-time contributor
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              creator: author
            });
            
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              creator: author
            });
            
            // Filter out the current PR and only count actual issues (not PRs)
            const previousPRs = prs.filter(pr => pr.number !== context.issue.number);
            const repoIssues = issues.filter(i => !i.pull_request && i.number !== context.issue.number);
            const isFirstTime = previousPRs.length === 0 && repoIssues.length === 0;
            
            let message;
            if (isFirstTime) {
              message = `ðŸŽ‰ Welcome @${author}! Thanks for opening your **first pull request** in this project! We're excited to have you join our community of contributors.
            
            Please make sure you've:
            - [ ] Read our [contributing guidelines](../CONTRIBUTING.md) (if available)
            - [ ] Followed our coding standards
            - [ ] Added tests if applicable
            - [ ] Updated documentation if needed
            
            A maintainer will review your PR soon. Don't hesitate to ask questions if you need help! ðŸš€`;
            } else {
              message = `ðŸ‘‹ Thanks for opening another pull request, @${author}! We appreciate your continued contributions to the project.
            
            Quick checklist:
            - [ ] Followed our coding standards
            - [ ] Added tests if applicable
            - [ ] Updated documentation if needed
            
            A maintainer will review your PR soon!`;
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });

      - name: Welcome message for new issues
        if: github.event_name == 'issues' && github.event.action == 'opened'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const author = context.payload.issue.user.login;
            
            // Check if this is a first-time contributor
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              creator: author
            });
            
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              creator: author
            });
            
            // Filter out the current issue from the count
            const previousIssues = issues.filter(issue => issue.number !== context.issue.number && !issue.pull_request);
            const isFirstTime = prs.length === 0 && previousIssues.length === 0;
            
            let message;
            if (isFirstTime) {
              message = `ðŸŽ‰ Welcome @${author}! Thanks for opening your **first issue** in this project! We appreciate you taking the time to contribute.
            
            Please make sure you've provided:
            - [ ] A clear and descriptive title
            - [ ] A detailed description of the issue
            - [ ] Steps to reproduce (if applicable)
            - [ ] Expected vs actual behavior
            - [ ] Any relevant screenshots or error messages
            
            We'll take a look as soon as possible! Feel free to ask questions if you need clarification. ðŸ™Œ`;
            } else {
              message = `ðŸ‘‹ Thanks for opening another issue, @${author}! We appreciate your continued engagement with the project.
            
            Quick checklist:
            - [ ] Clear description of the issue
            - [ ] Steps to reproduce (if applicable)
            - [ ] Expected vs actual behavior
            
            We'll take a look as soon as possible!`;
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });
