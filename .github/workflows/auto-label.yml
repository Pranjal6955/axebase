name: Auto Label PRs and Issues

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]
  issues:
    types: [opened, edited]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  auto-label:
    runs-on: ubuntu-latest
    name: Auto Label
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Label based on file changes (PRs only)
        if: github.event_name == 'pull_request'
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/pr-labeler.yaml
          sync-labels: true

      - name: Sync size labels (PRs only)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const issue_number = pr.number;
            const changes = pr.additions + pr.deletions;
            
            // Define size thresholds
            const sizes = [
              { label: 'size/xs', max: 10 },
              { label: 'size/s', max: 100 },
              { label: 'size/m', max: 500 },
              { label: 'size/l', max: 1000 },
              { label: 'size/xl', max: Infinity }
            ];
            
            // Determine correct size label
            let correctLabel = '';
            for (const size of sizes) {
              if (changes <= size.max) {
                correctLabel = size.label;
                break;
              }
            }
            
            // Get current labels
            const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number
            });
            
            // Remove all size labels
            const sizeLabels = sizes.map(s => s.label);
            for (const label of currentLabels) {
              if (sizeLabels.includes(label.name)) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue_number,
                  name: label.name
                });
              }
            }
            
            // Add correct size label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              labels: [correctLabel]
            });
            
            console.log(`PR has ${changes} changes. Applied label: ${correctLabel}`);

      - name: Sync content-based labels
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = context.issue.number;
            const isPR = !!context.payload.pull_request;
            const title = (isPR ? context.payload.pull_request.title : context.payload.issue.title) || '';
            const body = (isPR ? context.payload.pull_request.body : context.payload.issue.body) || '';
            const text = (title + ' ' + body).toLowerCase();
            
            // Define label rules
            const labelRules = {
              'bug': /\b(bug|error|issue|problem|crash|broken|fail|fix|not working|doesn't work|does not work)\b/,
              'enhancement': /\b(feature|enhancement|improvement|request|add|implement|support|enable|would be nice|could we|can we)\b/,
              'documentation': /\b(docs|documentation|readme|guide|tutorial|explain|clarify|document)\b/,
              'question': /\b(question|how to|help|wondering|what is|why does|when should)\b/,
              'performance': /\b(performance|slow|speed|optimize|optimization|faster|latency|bottleneck)\b/,
              'security': /\b(security|vulnerability|exploit|xss|csrf|injection|auth|authentication|authorization|permission)\b/,
              'ui/ux': /\b(ui|ux|design|layout|style|styling|interface|user experience|look and feel)\b/,
              'refactor': /\b(refactor|refactoring|cleanup|clean up|reorganize|code quality|technical debt)\b/,
              'breaking-change': /\b(breaking change|breaking|backwards incompatible|major version|migration required)\b/,
              'help-wanted': /\b(help wanted|help needed|looking for help|contributions welcome|need help)\b/
            };
            
            // Get current labels
            const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number
            });
            
            const currentLabelNames = currentLabels.map(l => l.name);
            const managedLabels = Object.keys(labelRules);
            
            // Determine which labels should be applied
            const labelsToApply = [];
            for (const [label, pattern] of Object.entries(labelRules)) {
              if (pattern.test(text)) {
                labelsToApply.push(label);
              }
            }
            
            // Remove labels that no longer apply
            for (const label of currentLabelNames) {
              if (managedLabels.includes(label) && !labelsToApply.includes(label)) {
                try {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue_number,
                    name: label
                  });
                  console.log(`Removed label: ${label}`);
                } catch (error) {
                  console.log(`Could not remove label ${label}: ${error.message}`);
                }
              }
            }
            
            // Add new labels
            const labelsToAdd = labelsToApply.filter(l => !currentLabelNames.includes(l));
            if (labelsToAdd.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue_number,
                labels: labelsToAdd
              });
              console.log(`Added labels: ${labelsToAdd.join(', ')}`);
            }

      - name: Label first-time contributors
        if: github.event_name == 'pull_request' && github.event.action == 'opened'
        uses: actions/first-interaction@v1
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          pr-message: |
            ðŸ‘‹ Thanks for opening your first pull request! We're excited to have you contributing to the project.
            
            Please make sure you've:
            - [ ] Followed our coding standards
            - [ ] Added tests if applicable
            - [ ] Updated documentation if needed
            
            A maintainer will review your PR soon!
          issue-message: |
            ðŸ‘‹ Thanks for opening your first issue! We appreciate you taking the time to contribute.
            
            Please make sure you've provided:
            - [ ] A clear description of the issue
            - [ ] Steps to reproduce (if applicable)
            - [ ] Expected vs actual behavior
            
            We'll take a look as soon as possible!
